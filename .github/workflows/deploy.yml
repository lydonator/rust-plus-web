name: Deploy to Production VPS

on:
  push:
    branches:
      - main  # Trigger on push to main branch
      - master  # Also support master branch

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PATH: ${{ secrets.VPS_PATH }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            set -e

            echo "=== Deploying Rust+ Web to Production ==="

            # Navigate to project directory
            cd ${{ secrets.VPS_PATH }}

            # Save current commit as rollback point
            CURRENT_COMMIT=$(git rev-parse HEAD)
            echo "$CURRENT_COMMIT" > .last-good-deploy
            echo "ðŸ“Œ Saved rollback point: $CURRENT_COMMIT"

            # Pull latest code
            echo "Pulling latest code from GitHub..."
            git fetch origin
            git reset --hard origin/master

            # Install dependencies (only if package.json changed)
            echo "Installing dependencies..."
            npm ci --production

            # Build Next.js frontend
            echo "Building Next.js application..."
            npm run build

            # Install cloud-shim dependencies
            echo "Installing cloud-shim dependencies..."
            cd cloud-shim
            npm ci --production
            cd ..

            # Restart services via PM2
            echo "Restarting services..."
            pm2 restart rust-plus-web || pm2 start npm --name rust-plus-web -- start
            pm2 restart cloud-shim || pm2 start cloud-shim/src/index.js --name cloud-shim
            pm2 restart status-monitor || echo "Status monitor not running, skipping..."

            # Save PM2 state
            pm2 save

            echo "=== Deployment Complete ==="
            pm2 status
          ENDSSH

      - name: Verify deployment
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            # Wait for services to start
            sleep 5

            # Check if main services are online
            if pm2 list | grep -E "rust-plus-web|cloud-shim" | grep -v online; then
              echo "Some services failed to start!"
              pm2 status
              exit 1
            fi

            echo "All services are running successfully"
            pm2 status
          ENDSSH

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed! Check GitHub Actions logs for details."
          echo ""
          echo "ðŸ”„ To rollback to the last good deploy, SSH to VPS and run:"
          echo "  cd ${{ secrets.VPS_PATH }}"
          echo "  git reset --hard \$(cat .last-good-deploy)"
          echo "  npm ci --production"
          echo "  npm run build"
          echo "  cd cloud-shim && npm ci --production && cd .."
          echo "  pm2 restart all"
          echo ""
          echo "ðŸ’¡ Or use the rollback script:"
          echo "  cd ${{ secrets.VPS_PATH }} && ./scripts/rollback.sh"
